import torch
from transformers import CLIPProcessor, CLIPModel
import requests
import json
import os
import re
import ast

# from logger import logger - –ó–∞–º–µ—Å—Ç–æ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–∏–Ω—Ç—ã

import settings

class Agent:
    def __init__(self):
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        self.device = settings.DEVICE
        self.openrouter_api_key = settings.OPENROUTER_API_KEY
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ CLIP
        self.model = CLIPModel.from_pretrained("zer0int/LongCLIP-GmP-ViT-L-14")
        self.processor = CLIPProcessor.from_pretrained("zer0int/LongCLIP-GmP-ViT-L-14")
        self.model.to(self.device)
        
        # –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è —Å—ã–ø–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
        self.rash_descriptions = [
            # –í–ï–ó–ò–ö–£–õ–Ø–†–ù–´–ï –í–´–°–´–ü–ê–ù–ò–Ø (—Å –ø—É–∑—ã—Ä—å–∫–∞–º–∏)
            "–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ–ª–∫–∏–µ –≤–µ–∑–∏–∫—É–ª—ã —Å –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –Ω–∞ –ø–æ–∫—Ä–∞—Å–Ω–µ–≤—à–µ–π –∫–æ–∂–µ",
            "–≥—Ä—É–ø–ø–∏—Ä—É—é—â–∏–µ—Å—è –≤–µ–∑–∏–∫—É–ª—ã –Ω–∞ —ç—Ä–∏—Ç–µ–º–∞—Ç–æ–∑–Ω–æ–º –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ —Å —Å–∏–ª—å–Ω—ã–º –∑—É–¥–æ–º",
            "–µ–¥–∏–Ω–∏—á–Ω—ã–µ –∫—Ä—É–ø–Ω—ã–µ –ø—É–∑—ã—Ä–∏ —Å —Å–µ—Ä–æ–∑–Ω—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –±–µ–∑ –≤–æ—Å–ø–∞–ª–µ–Ω–∏—è",
            "–≤–µ–∑–∏–∫—É–ª—ã —Å –≥–µ–º–æ—Ä—Ä–∞–≥–∏—á–µ—Å–∫–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –Ω–∞ –Ω–∏–∂–Ω–∏—Ö –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—è—Ö",
            
            # –ü–£–°–¢–£–õ–ï–ó–ù–´–ï –í–´–°–´–ü–ê–ù–ò–Ø (—Å –≥–Ω–æ–µ–º)
            "–ø—É—Å—Ç—É–ª—ã —Å –∂–µ–ª—Ç–æ–≤–∞—Ç—ã–º –≥–Ω–æ–π–Ω—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –∏ —ç—Ä–∏—Ç–µ–º–æ–π –ø–æ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏",
            "—Ñ–æ–ª–ª–∏–∫—É–ª—è—Ä–Ω—ã–µ –ø—É—Å—Ç—É–ª—ã —Å –≤–æ—Å–ø–∞–ª–µ–Ω–∏–µ–º –≤–æ–ª–æ—Å—è–Ω—ã—Ö —Ñ–æ–ª–ª–∏–∫—É–ª–æ–≤",
            "–ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã–µ –ø—É—Å—Ç—É–ª—ã –±–µ–∑ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤–æ—Å–ø–∞–ª–µ–Ω–∏—è",
            "–≥–ª—É–±–æ–∫–∏–µ –ø—É—Å—Ç—É–ª–µ–∑–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –±–æ–ª–µ–∑–Ω–µ–Ω–Ω–æ—Å—Ç—å—é –ø—Ä–∏ –ø–∞–ª—å–ø–∞—Ü–∏–∏",
            
            # –ü–ê–ü–£–õ–ï–ó–ù–´–ï –í–´–°–´–ü–ê–ù–ò–Ø (—É–∑–µ–ª–∫–∏)
            "–º–µ–ª–∫–∏–µ –ø–∞–ø—É–ª—ã –∫—Ä–∞—Å–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ —Å –±–ª–µ—Å—Ç—è—â–µ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å—é",
            "–ø–ª–æ—Å–∫–∏–µ –ø–∞–ø—É–ª—ã —Å —à–µ–ª—É—à–µ–Ω–∏–µ–º –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏",
            "—Ñ–∏–±—Ä–æ–∑–Ω—ã–µ –ø–∞–ø—É–ª—ã —Ç–µ–ª–µ—Å–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ –±–µ–∑ –≤–æ—Å–ø–∞–ª–µ–Ω–∏—è",
            "–≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞–ø—É–ª—ã —Å –æ—Ç–µ–∫–æ–º –∏ –≥–∏–ø–µ—Ä–µ–º–∏–µ–π",
            
            # –ü–Ø–¢–ù–ò–°–¢–´–ï –í–´–°–´–ü–ê–ù–ò–Ø
            "—ç—Ä–∏—Ç–µ–º–∞—Ç–æ–∑–Ω—ã–µ –ø—è—Ç–Ω–∞ —Ä–∞–∑–ª–∏—á–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —Å –Ω–µ—á–µ—Ç–∫–∏–º–∏ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏",
            "–≥–µ–º–æ—Ä—Ä–∞–≥–∏—á–µ—Å–∫–∏–µ –ø–µ—Ç–µ—Ö–∏–∏ —Ç–æ—á–µ—á–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –Ω–µ –±–ª–µ–¥–Ω–µ—é—â–∏–µ –ø—Ä–∏ –Ω–∞–¥–∞–≤–ª–∏–≤–∞–Ω–∏–∏",
            "–ø–∏–≥–º–µ–Ω—Ç–Ω—ã–µ –ø—è—Ç–Ω–∞ –∫–æ—Ä–∏—á–Ω–µ–≤–æ–≥–æ —Ü–≤–µ—Ç–∞ —Å —Ä–æ–≤–Ω—ã–º–∏ –∫—Ä–∞—è–º–∏",
            "–¥–µ–ø–∏–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—è—Ç–Ω–∞ –±–µ–ª–æ–≥–æ —Ü–≤–µ—Ç–∞ —Å —á–µ—Ç–∫–∏–º–∏ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏",
            
            # –ß–ï–®–£–ô–ß–ê–¢–´–ï –í–´–°–´–ü–ê–ù–ò–Ø
            "—Å–µ—Ä–µ–±—Ä–∏—Å—Ç—ã–µ —á–µ—à—É–π–∫–∏ –Ω–∞ —ç—Ä–∏—Ç–µ–º–∞—Ç–æ–∑–Ω—ã—Ö –±–ª—è—à–∫–∞—Ö",
            "–∫—Ä—É–ø–Ω—ã–µ –ø–ª–∞—Å—Ç–∏–Ω—á–∞—Ç—ã–µ —á–µ—à—É–π–∫–∏ —Å –≥–µ–Ω–µ—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º",
            "–º–µ–ª–∫–∏–µ –æ—Ç—Ä—É–±–µ–≤–∏–¥–Ω—ã–µ —á–µ—à—É–π–∫–∏ —Å –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–º –≤–æ—Å–ø–∞–ª–µ–Ω–∏–µ–º",
            "–∂–∏—Ä–Ω—ã–µ —á–µ—à—É–π–∫–∏ –∂–µ–ª—Ç–æ–≤–∞—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞ –≤ —Å–µ–±–æ—Ä–µ–π–Ω—ã—Ö –∑–æ–Ω–∞—Ö",
            
            # –£–†–¢–ò–ö–ê–†–ù–´–ï –í–´–°–´–ü–ê–ù–ò–Ø (–∫—Ä–∞–ø–∏–≤–Ω–∏—Ü–∞)
            "–≤–æ–ª–¥—ã—Ä–∏ –±–ª–µ–¥–Ω–æ-—Ä–æ–∑–æ–≤–æ–≥–æ —Ü–≤–µ—Ç–∞ —Å —ç—Ä–∏—Ç–µ–º–æ–π –ø–æ –∫—Ä–∞—è–º –∏ —Å–∏–ª—å–Ω—ã–º –∑—É–¥–æ–º",
            "–≥–∏–≥–∞–Ω—Ç—Å–∫–∏–µ —É—Ä—Ç–∏–∫–∞—Ä–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –∞–Ω–≥–∏–æ–Ω–µ–≤—Ä–æ—Ç–∏—á–µ—Å–∫–∏–º –æ—Ç–µ–∫–æ–º",
            "–º–∏–≥—Ä–∏—Ä—É—é—â–∏–µ –≤–æ–ª–¥—ã—Ä–∏ —Å –±—ã—Å—Ç—Ä—ã–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º –∏ –ø–æ—è–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö",
            
            # –≠–†–û–ó–ò–í–ù–´–ï/–Ø–ó–í–ï–ù–ù–´–ï –ü–û–†–ê–ñ–ï–ù–ò–Ø
            "—ç—Ä–æ–∑–∏–∏ —Å –º–æ–∫–Ω—É—Ç–∏–µ–º –∏ —Å–µ—Ä–æ–∑–Ω—ã–º —ç–∫—Å—Å—É–¥–∞—Ç–æ–º",
            "—è–∑–≤—ã —Å –≥–Ω–æ–π–Ω—ã–º –æ—Ç–¥–µ–ª—è–µ–º—ã–º –∏ –Ω–µ–∫—Ä–æ—Ç–∏—á–µ—Å–∫–∏–º –¥–Ω–æ–º",
            "–∞—Ñ—Ç—ã —Å —Ñ–∏–±—Ä–∏–Ω–æ–∑–Ω—ã–º –Ω–∞–ª–µ—Ç–æ–º –∏ –≥–∏–ø–µ—Ä–µ–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –≤–µ–Ω—á–∏–∫–æ–º",
            
            # –ò–ù–§–ï–ö–¶–ò–û–ù–ù–´–ï –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò
            "–≤—ã—Å—ã–ø–∞–Ω–∏—è —Å –≥–µ–º–æ—Ä—Ä–∞–≥–∏—á–µ—Å–∫–∏–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º –∏ –ª–∏—Ö–æ—Ä–∞–¥–∫–æ–π",
            "—Å—ã–ø—å —Å —Ç–µ–Ω–¥–µ–Ω—Ü–∏–µ–π –∫ —Å–ª–∏—è–Ω–∏—é –∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —Å–∏–º–ø—Ç–æ–º–æ–º –ö–æ–±–Ω–µ—Ä–∞",
            "–∫–æ–ª—å—Ü–µ–≤–∏–¥–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –ø—Ä–æ—Å–≤–µ—Ç–ª–µ–Ω–∏–µ–º –≤ —Ü–µ–Ω—Ç—Ä–µ",
            "–ª–∏–Ω–µ–π–Ω—ã–µ –≤—ã—Å—ã–ø–∞–Ω–∏—è –ø–æ —Ö–æ–¥—É –Ω–µ—Ä–≤–Ω—ã—Ö —Å—Ç–≤–æ–ª–æ–≤",
            
            # –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–Ø + –ú–û–†–§–û–õ–û–ì–ò–Ø
            "–¥–∏—Å–≥–∏–¥—Ä–æ—Ç–∏—á–µ—Å–∫–∏–µ –≤–µ–∑–∏–∫—É–ª—ã –Ω–∞ –ª–∞–¥–æ–Ω—è—Ö –∏ –ø–æ–¥–æ—à–≤–∞—Ö",
            "—Å–µ–±–æ—Ä–µ–π–Ω—ã–µ –≤—ã—Å—ã–ø–∞–Ω–∏—è –≤ –∑–æ–Ω–∞—Ö –±–æ–≥–∞—Ç—ã—Ö —Å–∞–ª—å–Ω—ã–º–∏ –∂–µ–ª–µ–∑–∞–º–∏",
            "–∏–Ω—Ç–µ—Ä—Ç—Ä–∏–≥–∏–Ω–æ–∑–Ω—ã–µ –≤—ã—Å—ã–ø–∞–Ω–∏—è –≤ —Å–∫–ª–∞–¥–∫–∞—Ö –∫–æ–∂–∏",
            "—Ñ–æ—Ç–æ–¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–Ω—ã–µ –≤—ã—Å—ã–ø–∞–Ω–∏—è –Ω–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —É—á–∞—Å—Ç–∫–∞—Ö –∫–æ–∂–∏",
            
            # –¶–í–ï–¢–û–í–´–ï –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò
            "—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–µ –ø–∞–ø—É–ª—ã —Å —Ç–µ–ª–µ–∞–Ω–≥–∏—ç–∫—Ç–∞–∑–∏—è–º–∏",
            "–∂–µ–ª—Ç–æ–≤–∞—Ç–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–µ –ø–∞–ø—É–ª—ã —Å —Ñ–æ–ª–ª–∏–∫—É–ª—è—Ä–Ω—ã–º –∫–µ—Ä–∞—Ç–æ–∑–æ–º",
            "—Å–∏–Ω—é—à–Ω—ã–µ —É–∑–ª—ã —Å –∑–∞–ø–∞–¥–µ–Ω–∏–µ–º –≤ —Ü–µ–Ω—Ç—Ä–µ",
            "–ø–µ—Ä–ª–∞–º—É—Ç—Ä–æ–≤—ã–µ –ø–∞–ø—É–ª—ã —Å —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–º –ø—É–ø–∫–æ–≤–∏–¥–Ω—ã–º –≤–¥–∞–≤–ª–µ–Ω–∏–µ–º",
            
            # –°–ò–°–¢–ï–ú–ù–´–ï –ü–†–û–Ø–í–õ–ï–ù–ò–Ø
            "—Å—ã–ø—å —Å –ª–∏–º—Ñ–∞–¥–µ–Ω–æ–ø–∞—Ç–∏–µ–π –∏ –ø–æ–≤—ã—à–µ–Ω–∏–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã",
            "–≤—ã—Å—ã–ø–∞–Ω–∏—è —Å –∞—Ä—Ç—Ä–∞–ª–≥–∏–µ–π –∏ –æ–±—â–∏–º –Ω–µ–¥–æ–º–æ–≥–∞–Ω–∏–µ–º",
            "–∫–æ–∂–Ω—ã–µ –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è —Å –∂–µ–ª—É–¥–æ—á–Ω–æ-–∫–∏—à–µ—á–Ω—ã–º–∏ —Å–∏–º–ø—Ç–æ–º–∞–º–∏"
        ]
        
        # –ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤
        self.generate_questions_prompt = """–¢—ã –æ–ø—ã—Ç–Ω—ã–π –≤—Ä–∞—á-–¥–µ—Ä–º–∞—Ç–æ–ª–æ–≥. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ–ø–∏—Å–∞–Ω–∏–µ —Å—ã–ø–∏ –∏ –∑–∞–¥–∞–π 3 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.

–û–ü–ò–°–ê–ù–ò–ï –°–´–ü–ò: {rash_description}

–ö–†–ò–¢–ï–†–ò–ò –í–û–ü–†–û–°–û–í:
- –í–æ–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –ø–æ–º–æ—á—å –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞—Ç—å –º–µ–∂–¥—É –∏–Ω—Ñ–µ–∫—Ü–∏–æ–Ω–Ω—ã–º–∏, –∞–ª–ª–µ—Ä–≥–∏—á–µ—Å–∫–∏–º–∏, –∞—É—Ç–æ–∏–º–º—É–Ω–Ω—ã–º–∏ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è–º–∏
- –£—á–∏—Ç—ã–≤–∞–π –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–Ω–∞—á–∞–ª–æ, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –¥–∏–Ω–∞–º–∏–∫–∞)
- –£—á–∏—Ç—ã–≤–∞–π —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω—ã–µ –æ—â—É—â–µ–Ω–∏—è (–∑—É–¥, –±–æ–ª—å, –∂–∂–µ–Ω–∏–µ)
- –£—á–∏—Ç—ã–≤–∞–π –ø—Ä–æ–≤–æ—Ü–∏—Ä—É—é—â–∏–µ –∏ –æ–±–ª–µ–≥—á–∞—é—â–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã
- –ù–µ –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –æ –¥–∏–∞–≥–Ω–æ–∑–µ - —Ç–æ–ª—å–∫–æ –æ —Å–∏–º–ø—Ç–æ–º–∞—Ö –∏ –∞–Ω–∞–º–Ω–µ–∑–µ
–û–ü–ò–°–ê–ù–ò–ï –°–´–ü–ò: {rash_description}

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –§–û–†–ú–ê–¢–£:
- –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: ["–≤–æ–ø—Ä–æ—Å1?", "–≤–æ–ø—Ä–æ—Å2?", "–≤–æ–ø—Ä–æ—Å3?"]
- –ë–µ–∑ –Ω–æ–º–µ—Ä–æ–≤, –±–µ–∑ —Ç–æ—á–µ–∫, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π
- –ö–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –≤ –∫–∞–≤—ã—á–∫–∞—Ö, —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –∑–∞–ø—è—Ç—ã–º–∏
- –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º —Å–ø–∏—Å–∫–æ–º Python

–í–û–ü–†–û–°–´:"""

        self.generate_recommendation_prompt = """–¢—ã –æ–ø—ã—Ç–Ω—ã–π –≤—Ä–∞—á-–¥–µ—Ä–º–∞—Ç–æ–ª–æ–≥. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª—É—á–∞–π –∏ –¥–∞–π –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã.

–î–ê–ù–ù–´–ï –ü–ê–¶–ò–ï–ù–¢–ê:
- –í–Ω–µ—à–Ω–∏–π –≤–∏–¥ —Å—ã–ø–∏: {rash_description}
- –í–æ–ø—Ä–æ—Å—ã –∫ –ø–∞—Ü–∏–µ–Ω—Ç—É: {questions}
- –û—Ç–≤–µ—Ç—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞: {question_answers}

–°–§–û–†–ú–£–õ–ò–†–£–ô –û–¢–í–ï–¢ –í –í–ò–î–ï –°–ü–ò–°–ö–ê –î–ò–ê–ì–ù–û–ó–û–í –° –ü–û–î–ü–£–ù–ö–¢–ê–ú–ò:

[
{{
"–¥–∏–∞–≥–Ω–æ–∑": "–ù–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –¥–∏–∞–≥–Ω–æ–∑–∞",
"–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å": "–Ω–∏–∑–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/–≤—ã—Å–æ–∫–∞—è",
"–æ—Ç–ª–∏—á–∏—è": "—á–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –¥—Ä—É–≥–∏—Ö –±–æ–ª–µ–∑–Ω–µ–π",
"—É—Ç–æ—á–Ω–µ–Ω–∏—è": "—á—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –≤—ã—è—Å–Ω–∏—Ç—å",
"–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞": "–∫–∞–∫–∏–µ –∞–Ω–∞–ª–∏–∑—ã –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è"
}},
{{
"–¥–∏–∞–≥–Ω–æ–∑": "–ù–∞–∑–≤–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –¥–∏–∞–≥–Ω–æ–∑–∞", 
"–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å": "–Ω–∏–∑–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/–≤—ã—Å–æ–∫–∞—è",
"–æ—Ç–ª–∏—á–∏—è": "—á–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –¥—Ä—É–≥–∏—Ö –±–æ–ª–µ–∑–Ω–µ–π",
"—É—Ç–æ—á–Ω–µ–Ω–∏—è": "—á—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –≤—ã—è—Å–Ω–∏—Ç—å",
"–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞": "–∫–∞–∫–∏–µ –∞–Ω–∞–ª–∏–∑—ã –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è"
}},
{{
"–¥–∏–∞–≥–Ω–æ–∑": "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ—Ç—å–µ–≥–æ –¥–∏–∞–≥–Ω–æ–∑–∞",
"–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å": "–Ω–∏–∑–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/–≤—ã—Å–æ–∫–∞—è", 
"–æ—Ç–ª–∏—á–∏—è": "—á–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –¥—Ä—É–≥–∏—Ö –±–æ–ª–µ–∑–Ω–µ–π",
"—É—Ç–æ—á–Ω–µ–Ω–∏—è": "—á—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –≤—ã—è—Å–Ω–∏—Ç—å",
"–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞": "–∫–∞–∫–∏–µ –∞–Ω–∞–ª–∏–∑—ã –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è"
}}
]

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –§–û–†–ú–ê–¢–£:
- –î–∞–π 2-3 –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω—ã—Ö –¥–∏–∞–≥–Ω–æ–∑–∞
- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ—á–Ω—ã–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã
- –û—Ü–µ–Ω–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ –¥–∏–∞–≥–Ω–æ–∑–∞
- –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –≤ –æ—Ç–ª–∏—á–∏—è—Ö –∏ –º–µ—Ç–æ–¥–∞—Ö –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏—á–µ–≥–æ –∫—Ä–æ–º–µ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞"""


        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ KoboldCPP
        self.koboldcpp_url = "http://localhost:8888"  # –∏–ª–∏ –≤–∞—à URL KoboldCPP
        self.koboldcpp_api_url = f"{self.koboldcpp_url}/api/v1/generate"
    
    def generate_questions(self, image):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ OpenRouter"""
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è CLIP
        inputs = self.processor(
            text=self.rash_descriptions, 
            images=image, 
            return_tensors="pt", 
            padding=True
        ).to(self.device)
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π
        with torch.no_grad():
            outputs = self.model(**inputs)
            logits_per_image = outputs.logits_per_image
            probs = logits_per_image.softmax(dim=1)
            
            # –ù–∞—Ö–æ–¥–∏–º –ª—É—á—à–µ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
            best_match_idx = probs.argmax().item()
            confidence = probs[0][best_match_idx].item()
            
        best_description = self.rash_descriptions[best_match_idx]
        print(f'Best descriptor is: {best_description}')
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å—ã–ø–∏
        prompt = self.generate_questions_prompt.format(rash_description=best_description)
        
        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ KoboldCPP
        payload = {
            "prompt": prompt,
            "max_length": 200,
            "temperature": 0.7,
            "top_p": 0.9,
            "top_k": 40,
            "typical_p": 1.0,
            "rep_pen": 1.1,
            "rep_pen_range": 256,
            "rep_pen_slope": 1.0,
            "tfs": 0.9,
            "stop": ["\n\n", "###", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:", "–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç:"],
            "stream": False
        }
        
        headers = {
            "Content-Type": "application/json"
        }
        
        try:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ KoboldCPP
            response = requests.post(
                self.koboldcpp_api_url,
                headers=headers,
                json=payload,
                timeout=120  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏
            )
            
            if response.status_code == 200:
                result = response.json()
                questions_text = result['results'][0]['text'].strip()
                
                return self.parse_questions_list(questions_text), best_description
            else:
                return f"–û—à–∏–±–∫–∞ KoboldCPP API: {response.status_code} - {response.text}"
                
        except requests.exceptions.ConnectionError:
            return "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ KoboldCPP. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω"
        except Exception as e:
            return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ KoboldCPP: {str(e)}"

    def parse_questions_list(self, text):
        """–ü–∞—Ä—Å–∏—Ç —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
        fallback_questions = "1. –ö–æ–≥–¥–∞ –ø–æ—è–≤–∏–ª–∞—Å—å —Å—ã–ø—å?\n2. –ï—Å—Ç—å –ª–∏ –∑—É–¥, –±–æ–ª—å –∏–ª–∏ –∂–∂–µ–Ω–∏–µ?\n3. –ß—Ç–æ –ø—Ä–µ–¥—à–µ—Å—Ç–≤–æ–≤–∞–ª–æ –ø–æ—è–≤–ª–µ–Ω–∏—é —Å—ã–ø–∏?"
        try:
            # –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω —Å–ø–∏—Å–∫–∞: ["...?", "...?", "...?"]
            list_match = re.search(r'\[.*\]', text, re.DOTALL)
            if list_match:
                list_str = list_match.group(0)
                questions = ast.literal_eval(list_str)
                if isinstance(questions, list) and len(questions) >= 2:
                    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
                    return "\n".join([f"{i+1}. {q}" for i, q in enumerate(questions)])
            
            # Fallback: –∏—â–µ–º –≤–æ–ø—Ä–æ—Å—ã –≤ –∫–∞–≤—ã—á–∫–∞—Ö
            quoted_questions = re.findall(r'\"([^\"]+\?)\"', text)
            if len(quoted_questions) >= 2:
                return "\n".join([f"{i+1}. {q}" for i, q in enumerate(quoted_questions[:3])])
            
            # Fallback 2: –∏—â–µ–º –≤–æ–ø—Ä–æ—Å—ã –±–µ–∑ –∫–∞–≤—ã—á–µ–∫ –Ω–æ —Å –∑–Ω–∞–∫–∞–º–∏ –≤–æ–ø—Ä–æ—Å–∞
            question_pattern = r'([^.?!]+\?)'
            all_questions = re.findall(question_pattern, text)
            if len(all_questions) >= 2:
                # –§–∏–ª—å—Ç—Ä—É–µ–º —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ "–≤–æ–ø—Ä–æ—Å—ã"
                filtered_questions = [q.strip() for q in all_questions if len(q.strip()) > 10]
                if len(filtered_questions) >= 2:
                    return "\n".join([f"{i+1}. {q}" for i, q in enumerate(filtered_questions[:3])])
            
            return fallback_questions
            
        except Exception as e:
            return fallback_questions

    def generate_recommendation(self, questions, question_answers, rash_description ):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∫–∞–∫ –≤—Ä–∞—á-–¥–µ—Ä–º–∞—Ç–æ–ª–æ–≥ —Å —á—ë—Ç–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π"""
        payload = {
            "prompt": self.generate_recommendation_prompt.format(questions=questions,
            question_answers=question_answers, 
            rash_description=rash_description),
            "max_length": 800,
            "temperature": 0.3,
            "top_p": 0.8,
            "stop": ["###", "–ü–†–ò–ú–ï–ß–ê–ù–ò–ï", "–í–ê–ñ–ù–û"],
            "stream": False
        }
        
        try:
            response = requests.post(
                self.koboldcpp_api_url,
                headers={"Content-Type": "application/json"},
                json=payload,
                timeout=120
            )
            
            if response.status_code == 200:
                raw_text = response.json()['results'][0]['text'].strip()
                print(f"üìù –°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏:\n{raw_text}")
                
                # –ü–∞—Ä—Å–∏–º —Å–ø–∏—Å–æ–∫ –¥–∏–∞–≥–Ω–æ–∑–æ–≤
                diagnoses = self.parse_diagnoses_list(raw_text)
                return self.format_as_doctor_recommendation(diagnoses, rash_description)
            else:
                return self.get_doctor_fallback_recommendation(rash_description)
                
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
            return self.get_doctor_fallback_recommendation(rash_description)

    def parse_diagnoses_list(self, raw_text):
        """–ü–∞—Ä—Å–∏—Ç —Å–ø–∏—Å–æ–∫ –¥–∏–∞–≥–Ω–æ–∑–æ–≤ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –º–æ–¥–µ–ª–∏"""
        try:
            import re
            import json
            
            # –ò—â–µ–º JSON-–ø–æ–¥–æ–±–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
            json_match = re.search(r'\[.*\]', raw_text, re.DOTALL)
            if json_match:
                json_str = json_match.group(0)
                # –ß–∏—Å—Ç–∏–º JSON –æ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
                json_str = re.sub(r',\s*}', '}', json_str)  # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –∑–∞–ø—è—Ç—ã–µ
                json_str = re.sub(r',\s*]', ']', json_str)
                
                diagnoses = json.loads(json_str)
                if isinstance(diagnoses, list) and len(diagnoses) > 0:
                    return diagnoses
            
            # Fallback: –ø–∞—Ä—Å–∏–º –≤—Ä—É—á–Ω—É—é –µ—Å–ª–∏ JSON –Ω–µ –Ω–∞–π–¥–µ–Ω
            return self.parse_diagnoses_manual(raw_text)
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}")
            return self.parse_diagnoses_manual(raw_text)

    def parse_diagnoses_manual(self, raw_text):
        """–†—É—á–Ω–æ–π –ø–∞—Ä—Å–∏–Ω–≥ –¥–∏–∞–≥–Ω–æ–∑–æ–≤ –µ—Å–ª–∏ JSON –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª"""
        diagnoses = []
        lines = raw_text.split('\n')
        
        current_diagnosis = {}
        
        for line in lines:
            line = line.strip()
            if not line:
                continue
                
            # –ò—â–µ–º –Ω–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ –¥–∏–∞–≥–Ω–æ–∑–∞
            if '"–¥–∏–∞–≥–Ω–æ–∑"' in line or '–¥–∏–∞–≥–Ω–æ–∑' in line:
                if current_diagnosis:
                    diagnoses.append(current_diagnosis)
                    current_diagnosis = {}
                
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–∏–∞–≥–Ω–æ–∑–∞
                match = re.search(r'["\']?–¥–∏–∞–≥–Ω–æ–∑["\']?\s*:\s*["\']([^"\']+)["\']', line)
                if match:
                    current_diagnosis['–¥–∏–∞–≥–Ω–æ–∑'] = match.group(1)
            
            # –ü–∞—Ä—Å–∏–º –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
            for field in ['–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å', '–æ—Ç–ª–∏—á–∏—è', '—É—Ç–æ—á–Ω–µ–Ω–∏—è', '–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞']:
                if f'"{field}"' in line or field in line:
                    match = re.search(r'["\']?' + field + r'["\']?\s*:\s*["\']([^"\']+)["\']', line)
                    if match and current_diagnosis:
                        current_diagnosis[field] = match.group(1)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–∏–∞–≥–Ω–æ–∑
        if current_diagnosis:
            diagnoses.append(current_diagnosis)
        
        return diagnoses if diagnoses else self.get_fallback_diagnoses()

    def format_as_doctor_recommendation(self, diagnoses, rash_description):
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∏–∞–≥–Ω–æ–∑—ã –∫–∞–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –≤—Ä–∞—á–∞"""
        if not diagnoses:
            return self.get_doctor_fallback_recommendation(rash_description)
        
        output = f"üè• –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï –ê–ì–ï–ù–¢–ê\n\n"
        output += f"–ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞: {rash_description}\n\n"
        output += "–î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ï–î–ü–û–õ–û–ñ–ï–ù–ò–Ø:\n\n"
        
        for i, diag in enumerate(diagnoses, 1):
            output += f"{i}. {diag.get('–¥–∏–∞–≥–Ω–æ–∑', '–£—Ç–æ—á–Ω—è—é—â–∏–π –¥–∏–∞–≥–Ω–æ–∑')}\n"
            output += f"   ‚Ä¢ –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: {diag.get('–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å', '—Ç—Ä–µ–±—É–µ—Ç —É—Ç–æ—á–Ω–µ–Ω–∏—è')}\n"
            output += f"   ‚Ä¢ –û—Ç–ª–∏—á–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏: {diag.get('–æ—Ç–ª–∏—á–∏—è', '—Ç—Ä–µ–±—É–µ—Ç –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏')}\n"
            output += f"   ‚Ä¢ –ß—Ç–æ —É—Ç–æ—á–Ω–∏—Ç—å: {diag.get('—É—Ç–æ—á–Ω–µ–Ω–∏—è', '–¥–∏–Ω–∞–º–∏–∫–∞ —Å–∏–º–ø—Ç–æ–º–æ–≤, –æ—Ç–≤–µ—Ç –Ω–∞ –ª–µ—á–µ–Ω–∏–µ')}\n"
            output += f"   ‚Ä¢ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: {diag.get('–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞', '–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞, –±–∞–∑–æ–≤—ã–µ –∞–Ω–∞–ª–∏–∑—ã')}\n\n"
        
        output += "üìã –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:\n"
        output += "‚Ä¢ –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –≤—Ä–∞—á—É-–¥–µ—Ä–º–∞—Ç–æ–ª–æ–≥—É –¥–ª—è –æ—á–Ω–æ–≥–æ –æ—Å–º–æ—Ç—Ä–∞\n"
        output += "‚Ä¢ –ü—Ä–æ–π—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è\n"
        output += "‚Ä¢ –ù–µ –∑–∞–Ω–∏–º–∞—Ç—å—Å—è —Å–∞–º–æ–ª–µ—á–µ–Ω–∏–µ–º\n\n"
        output += "‚ö†Ô∏è –≠—Ç–æ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã. –¢–æ—á–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ –º–æ–∂–µ—Ç –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤—Ä–∞—á –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è."
        
        return output

    def get_doctor_fallback_recommendation(self, rash_description):
        """–ó–∞–ø–∞—Å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Ç –≤—Ä–∞—á–∞"""
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∑–∞–ø–∞—Å–Ω—ã—Ö –¥–∏–∞–≥–Ω–æ–∑–æ–≤
        if "–ª–∏–Ω–µ–π–Ω" in rash_description.lower() or "–Ω–µ—Ä–≤" in rash_description.lower():
            diagnoses = [
                {
                    "–¥–∏–∞–≥–Ω–æ–∑": "–û–ø–æ—è—Å—ã–≤–∞—é—â–∏–π –≥–µ—Ä–ø–µ—Å (Herpes zoster)",
                    "–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å": "—Å—Ä–µ–¥–Ω—è—è",
                    "–æ—Ç–ª–∏—á–∏—è": "–ª–∏–Ω–µ–π–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ —Ö–æ–¥—É –Ω–µ—Ä–≤–æ–≤, –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–æ—Å—Ç—å",
                    "—É—Ç–æ—á–Ω–µ–Ω–∏—è": "–Ω–∞–ª–∏—á–∏–µ –±–æ–ª–∏, –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–∏–µ –≤—ã—Å—ã–ø–∞–Ω–∏—è, –∏–º–º—É–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å",
                    "–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞": "–ü–¶–†-–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, –∏–º–º—É–Ω–æ—Ñ–µ—Ä–º–µ–Ω—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑"
                },
                {
                    "–¥–∏–∞–≥–Ω–æ–∑": "–õ–∏–Ω–µ–π–Ω—ã–π –ª–∏—Ö–µ–Ω",
                    "–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å": "–Ω–∏–∑–∫–∞—è", 
                    "–æ—Ç–ª–∏—á–∏—è": "–¥–æ–±—Ä–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ç–µ—á–µ–Ω–∏–µ, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ—è–≤–ª–µ–Ω–∏–π",
                    "—É—Ç–æ—á–Ω–µ–Ω–∏—è": "–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è, –¥–∏–Ω–∞–º–∏–∫–∞ –≤—ã—Å—ã–ø–∞–Ω–∏–π",
                    "–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞": "–¥–µ—Ä–º–∞—Ç–æ—Å–∫–æ–ø–∏—è, –≥–∏—Å—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ"
                }
            ]
        else:
            diagnoses = [
                {
                    "–¥–∏–∞–≥–Ω–æ–∑": "–ê–ª–ª–µ—Ä–≥–∏—á–µ—Å–∫–∏–π –¥–µ—Ä–º–∞—Ç–∏—Ç",
                    "–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å": "—Å—Ä–µ–¥–Ω—è—è",
                    "–æ—Ç–ª–∏—á–∏—è": "—Å–≤—è–∑—å —Å –∫–æ–Ω—Ç–∞–∫—Ç–æ–º —Å –∞–ª–ª–µ—Ä–≥–µ–Ω–∞–º–∏, –ø–æ–ª–∏–º–æ—Ä—Ñ–∏–∑–º –≤—ã—Å—ã–ø–∞–Ω–∏–π",
                    "—É—Ç–æ—á–Ω–µ–Ω–∏—è": "–∫–æ–Ω—Ç–∞–∫—Ç—ã —Å –Ω–æ–≤—ã–º–∏ –≤–µ—â–µ—Å—Ç–≤–∞–º–∏, —ç—Ñ—Ñ–µ–∫—Ç –æ—Ç –∞–Ω—Ç–∏–≥–∏—Å—Ç–∞–º–∏–Ω–Ω—ã—Ö",
                    "–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞": "–æ–±—â–∏–π –∞–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏, –∞–ª–ª–µ—Ä–≥–æ–ø—Ä–æ–±—ã"
                },
                {
                    "–¥–∏–∞–≥–Ω–æ–∑": "–ë–∞–∫—Ç–µ—Ä–∏–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–µ–∫—Ü–∏—è –∫–æ–∂–∏",
                    "–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å": "–Ω–∏–∑–∫–∞—è",
                    "–æ—Ç–ª–∏—á–∏—è": "–≤–æ–∑–º–æ–∂–Ω–æ–µ –≥–Ω–æ–π–Ω–æ–µ –æ—Ç–¥–µ–ª—è–µ–º–æ–µ, —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–∏–º–ø—Ç–æ–º—ã", 
                    "—É—Ç–æ—á–Ω–µ–Ω–∏—è": "–Ω–∞–ª–∏—á–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã, —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è",
                    "–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞": "–æ–±—â–∏–π –∞–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏, –±–∞–∫—Ç–µ—Ä–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Å–µ–≤"
                }
            ]
        
        return self.format_as_doctor_recommendation(diagnoses, rash_description)

    def get_fallback_diagnoses(self):
        """–ë–∞–∑–æ–≤—ã–µ –∑–∞–ø–∞—Å–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã"""
        return [
            {
                "–¥–∏–∞–≥–Ω–æ–∑": "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –¥–µ—Ä–º–∞—Ç–æ–ª–æ–≥–∞",
                "–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å": "–≤—ã—Å–æ–∫–∞—è",
                "–æ—Ç–ª–∏—á–∏—è": "—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—á–Ω—ã–π –æ—Å–º–æ—Ç—Ä –¥–ª—è —Ç–æ—á–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏",
                "—É—Ç–æ—á–Ω–µ–Ω–∏—è": "–¥–∏–Ω–∞–º–∏–∫–∞ –≤—ã—Å—ã–ø–∞–Ω–∏–π, –æ—Ç–≤–µ—Ç –Ω–∞ –ª–µ—á–µ–Ω–∏–µ",
                "–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞": "–æ—Å–º–æ—Ç—Ä —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞, –¥–µ—Ä–º–∞—Ç–æ—Å–∫–æ–ø–∏—è"
            }
        ]

agent = Agent()